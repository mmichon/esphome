esphome:
  name: trmnl-design
  friendly_name: trmnl-design
  on_boot:
    priority: 600
    then:
      - output.turn_on: bsp_battery_enable
      - delay: 2s  # Wait for Home Assistant API connection
      - script.execute: manage_run_and_sleep

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  # encryption:
  #   key: "iTaL5215FFghb0Wk3h9iDIvygykxGqHCvp5hd1U2xBQ="

ota:
  - platform: esphome
    password: "ced30847b4962f63427e710076817651"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Trmnl-Design Fallback Hotspot"
    password: "ZGCdcIXaVRek"

captive_portal:

globals:
  - id: display_page
    type: int
    restore_value: true
    initial_value: '0'
  - id: page_refresh_default_s
    type: int
    restore_value: true
    initial_value: '600'
  - id: page_refresh_current_s
    type: int
    restore_value: false
    initial_value: '60'
  - id: last_page_switch_time
    type: uint32_t
    restore_value: false
    initial_value: '0'
  - id: quote_text_w_mjhva2g0qs70i_global
    type: std::string
    restore_value: true
    initial_value: '""'
  - id: quote_author_w_mjhva2g0qs70i_global
    type: std::string
    restore_value: true
    initial_value: '""'

psram:
  mode: octal
  speed: 80MHz

http_request:
  verify_ssl: false
  timeout: 20s

i2c:
  - sda: GPIO17
    scl: GPIO18
    scan: true
    id: bus_a

spi:
  - id: spi_bus
    clk_pin: GPIO7
    mosi_pin: GPIO9

output:
  - platform: gpio
    pin: GPIO6
    id: bsp_battery_enable

time:
  - platform: homeassistant
    id: ha_time

sensor:
  - platform: adc
    pin: GPIO1
    name: "Battery Voltage"
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    id: battery_voltage
    update_interval: 60s
    attenuation: 12db
    filters:
      - multiply: 2
  - platform: homeassistant
    id: sensor_lights
    entity_id: sensor.lights
    internal: true
  - platform: homeassistant
    id: sensor_147_123_1min
    entity_id: sensor.147_123_1min
    internal: true
  - platform: homeassistant
    id: sensor_estimated_monthly_cost
    entity_id: sensor.estimated_monthly_cost
    internal: true
  - platform: homeassistant
    id: weather_high_day0
    entity_id: sensor.weather_forecast_day_0_high
    internal: true
  - platform: homeassistant
    id: weather_low_day0
    entity_id: sensor.weather_forecast_day_0_low
    internal: true
  - platform: homeassistant
    id: weather_high_day1
    entity_id: sensor.weather_forecast_day_1_high
    internal: true
  - platform: homeassistant
    id: weather_low_day1
    entity_id: sensor.weather_forecast_day_1_low
    internal: true
  - platform: homeassistant
    id: weather_high_day2
    entity_id: sensor.weather_forecast_day_2_high
    internal: true
  - platform: homeassistant
    id: weather_low_day2
    entity_id: sensor.weather_forecast_day_2_low
    internal: true
  - platform: homeassistant
    id: weather_high_day3
    entity_id: sensor.weather_forecast_day_3_high
    internal: true
  - platform: homeassistant
    id: weather_low_day3
    entity_id: sensor.weather_forecast_day_3_low
    internal: true
  - platform: homeassistant
    id: weather_high_day4
    entity_id: sensor.weather_forecast_day_4_high
    internal: true
  - platform: homeassistant
    id: weather_low_day4
    entity_id: sensor.weather_forecast_day_4_low
    internal: true
  # WiFi Signal Strength Sensor
  - platform: wifi_signal
    name: "WiFi Signal"
    id: wifi_signal_dbm
    update_interval: 60s

  - platform: template
    name: "Battery Level"
    id: battery_level
    unit_of_measurement: "%"
    icon: "mdi:battery"
    device_class: battery
    state_class: measurement
    lambda: 'return id(battery_voltage).state;'
    update_interval: 60s
    filters:
      - calibrate_linear:
          - 4.15 -> 100
          - 3.96 -> 90
          - 3.91 -> 80
          - 3.85 -> 70
          - 3.8 -> 60
          - 3.75 -> 50
          - 3.68 -> 40
          - 3.58 -> 30
          - 3.49 -> 20
          - 3.41 -> 10
          - 3.3 -> 5
          - 3.27 -> 0
      - clamp:
          min_value: 0
          max_value: 100

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO2
      mode: INPUT_PULLUP
      inverted: true
    name: "Left Button"
    id: button_left
    on_press:
      then:
        - script.execute:
            id: change_page_to
            target_page: !lambda 'return id(display_page) > 0 ? id(display_page) - 1 : 0;'
  - platform: gpio
    pin:
      number: GPIO5
      mode: INPUT_PULLUP
      inverted: true
    name: "Refresh Button"
    id: button_refresh
    on_press:
      then:
        - component.update: epaper_display

button:
  - platform: template
    name: "Next Page"
    on_press:
      then:
        - script.execute:
            id: change_page_to
            target_page: !lambda 'return id(display_page) + 1;'
  - platform: template
    name: "Previous Page"
    on_press:
      then:
        - script.execute:
            id: change_page_to
            target_page: !lambda 'return id(display_page) - 1;'
  - platform: template
    name: "Refresh Display"
    on_press:
      then:
        - component.update: epaper_display
  - platform: template
    name: "Go to Page 1"
    on_press:
      then:
        - script.execute:
            id: change_page_to
            target_page: 0

graph:
  - id: graph_w_mjhvefqifbsmo
    duration: 1h
    width: 331
    height: 129
    border: true
    x_grid: 15min
    y_grid: 50
    traces:
      - sensor: sensor_147_123_1min
        line_thickness: 3
        continuous: true

text_sensor:
  # Home Assistant Text Sensors
  - platform: homeassistant
    id: sensor_lights_on_txt
    entity_id: sensor.lights_on
    internal: true
  - platform: homeassistant
    id: input_boolean_guest_mode_txt
    entity_id: input_boolean.guest_mode
    internal: true
  - platform: homeassistant
    id: binary_sensor_exterior_doors_txt
    entity_id: binary_sensor.exterior_doors
    internal: true
  - platform: homeassistant
    id: input_boolean_alarm_armed_txt
    entity_id: input_boolean.alarm_armed
    internal: true

  # Quote/RSS Widget Sensors (local, populated via http_request)
  - platform: template
    id: quote_text_w_mjhva2g0qs70i
    name: "Quote Text w_mjhva2g0qs70i"
    lambda: 'return id(quote_text_w_mjhva2g0qs70i_global);'
  - platform: template
    id: quote_author_w_mjhva2g0qs70i
    name: "Quote Author w_mjhva2g0qs70i"
    lambda: 'return id(quote_author_w_mjhva2g0qs70i_global);'

  # Weather Forecast Condition Sensors
  - platform: homeassistant
    id: weather_cond_day0
    entity_id: sensor.weather_forecast_day_0_condition
    internal: true
  - platform: homeassistant
    id: weather_cond_day1
    entity_id: sensor.weather_forecast_day_1_condition
    internal: true
  - platform: homeassistant
    id: weather_cond_day2
    entity_id: sensor.weather_forecast_day_2_condition
    internal: true
  - platform: homeassistant
    id: weather_cond_day3
    entity_id: sensor.weather_forecast_day_3_condition
    internal: true
  - platform: homeassistant
    id: weather_cond_day4
    entity_id: sensor.weather_forecast_day_4_condition
    internal: true
  # Calendar Widget Sensors (from Home Assistant)
  - platform: homeassistant
    id: calendar_json_w_mjhv9oq4acqqx
    entity_id: sensor.esp_calendar_data
    attribute: entries
    internal: true
  - platform: homeassistant
    id: todays_day_name_w_mjhv9oq4acqqx
    entity_id: sensor.esp_calendar_data
    attribute: todays_day_name
    internal: true
  - platform: homeassistant
    id: todays_date_month_year_w_mjhv9oq4acqqx
    entity_id: sensor.esp_calendar_data
    attribute: todays_date_month_year
    internal: true

interval:
  # Quote widget: w_mjhva2g0qs70i
  - interval: 1h
    startup_delay: 30s
    then:
      - if:
          condition:
            wifi.connected:
          then:
            - http_request.get:
                url: "http://homeassistant.local:8123/api/reterminal_dashboard/rss_proxy?url=https%3A%2F%2Fscript.google.com%2Fmacros%2Fs%2FAKfycbzs-IaE4gHCMOaZFgcZgV_phZgI1mPz0gCPUM-Liok2G2_R6e-AAR7-1f-qKLNvnRU9Tg%2Fexec&random=true"
                capture_response: true
                on_response:
                  - lambda: |-
                      if (response->status_code == 200) {
                        DynamicJsonDocument doc(4096);
                        DeserializationError error = deserializeJson(doc, body);
                        if (error) {
                          ESP_LOGW("quote", "Failed to parse JSON: %s", error.c_str());
                          return;
                        }
                        if (doc.containsKey("success") && doc["success"].as<bool>()) {
                          JsonObject quote = doc["quote"];
                          if (!quote.isNull()) {
                            std::string q_text = quote["quote"].as<std::string>();
                            std::string q_author = quote["author"].as<std::string>();
                            id(quote_text_w_mjhva2g0qs70i_global) = q_text;
                            id(quote_author_w_mjhva2g0qs70i_global) = q_author;
                            ESP_LOGI("quote", "Fetched quote: %s", q_text.c_str());
                          }
                        }
                        id(epaper_display).update();
                      } else {
                        ESP_LOGW("quote", "HTTP Request failed with code: %d", response->status_code);
                      }

# ============================================================================
# CALENDAR WIDGET SETUP
# Requires 'esp_calendar_data_conversion.py' in HA python_scripts/
# (You can download this script from the Calendar Widget properties panel in the designer)
# and a corresponding template sensor configuration.
# See documentation/walkthrough for details.
#
# Based on the work by paviro: https://github.com/paviro/ESPHome-ePaper-Calendar
# ============================================================================

# ============================================================================
# HOME ASSISTANT TEMPLATE SENSORS
# Add these template sensors to your Home Assistant configuration.yaml:
# ============================================================================
#
# template:
#   - trigger:
#       - trigger: state
#         entity_id: weather.forecast_home  # Replace with your weather entity
#       - trigger: time_pattern
#         hours: "/1"
#     action:
#       - action: weather.get_forecasts
#         target:
#           entity_id: weather.forecast_home  # Replace with your weather entity
#         data:
#           type: daily
#         response_variable: forecast_data
#     sensor:
#       - name: "Weather Forecast Day 0 High"
#         unique_id: weather_forecast_day_0_high
#         unit_of_measurement: "°C"
#         state: "{{ forecast_data['weather.forecast_home'].forecast[0].temperature | default('N/A') }}"
#       - name: "Weather Forecast Day 0 Low"
#         unique_id: weather_forecast_day_0_low
#         unit_of_measurement: "°C"
#         state: "{{ forecast_data['weather.forecast_home'].forecast[0].templow | default('N/A') }}"
#       - name: "Weather Forecast Day 0 Condition"
#         unique_id: weather_forecast_day_0_condition
#         state: "{{ forecast_data['weather.forecast_home'].forecast[0].condition | default('cloudy') }}"
#       - name: "Weather Forecast Day 1 High"
#         unique_id: weather_forecast_day_1_high
#         unit_of_measurement: "°C"
#         state: "{{ forecast_data['weather.forecast_home'].forecast[1].temperature | default('N/A') }}"
#       - name: "Weather Forecast Day 1 Low"
#         unique_id: weather_forecast_day_1_low
#         unit_of_measurement: "°C"
#         state: "{{ forecast_data['weather.forecast_home'].forecast[1].templow | default('N/A') }}"
#       - name: "Weather Forecast Day 1 Condition"
#         unique_id: weather_forecast_day_1_condition
#         state: "{{ forecast_data['weather.forecast_home'].forecast[1].condition | default('cloudy') }}"
#       - name: "Weather Forecast Day 2 High"
#         unique_id: weather_forecast_day_2_high
#         unit_of_measurement: "°C"
#         state: "{{ forecast_data['weather.forecast_home'].forecast[2].temperature | default('N/A') }}"
#       - name: "Weather Forecast Day 2 Low"
#         unique_id: weather_forecast_day_2_low
#         unit_of_measurement: "°C"
#         state: "{{ forecast_data['weather.forecast_home'].forecast[2].templow | default('N/A') }}"
#       - name: "Weather Forecast Day 2 Condition"
#         unique_id: weather_forecast_day_2_condition
#         state: "{{ forecast_data['weather.forecast_home'].forecast[2].condition | default('cloudy') }}"
#       - name: "Weather Forecast Day 3 High"
#         unique_id: weather_forecast_day_3_high
#         unit_of_measurement: "°C"
#         state: "{{ forecast_data['weather.forecast_home'].forecast[3].temperature | default('N/A') }}"
#       - name: "Weather Forecast Day 3 Low"
#         unique_id: weather_forecast_day_3_low
#         unit_of_measurement: "°C"
#         state: "{{ forecast_data['weather.forecast_home'].forecast[3].templow | default('N/A') }}"
#       - name: "Weather Forecast Day 3 Condition"
#         unique_id: weather_forecast_day_3_condition
#         state: "{{ forecast_data['weather.forecast_home'].forecast[3].condition | default('cloudy') }}"
#       - name: "Weather Forecast Day 4 High"
#         unique_id: weather_forecast_day_4_high
#         unit_of_measurement: "°C"
#         state: "{{ forecast_data['weather.forecast_home'].forecast[4].temperature | default('N/A') }}"
#       - name: "Weather Forecast Day 4 Low"
#         unique_id: weather_forecast_day_4_low
#         unit_of_measurement: "°C"
#         state: "{{ forecast_data['weather.forecast_home'].forecast[4].templow | default('N/A') }}"
#       - name: "Weather Forecast Day 4 Condition"
#         unique_id: weather_forecast_day_4_condition
#         state: "{{ forecast_data['weather.forecast_home'].forecast[4].condition | default('cloudy') }}"
#
# ============================================================================

font:
  - file:
      type: gfonts
      family: Roboto
      weight: 400
    id: font_roboto_400_20
    size: 20
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002a", "\U0000002b", "\U0000002c", "\U0000002d", "\U0000002e", "\U0000002f", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003a", "\U0000003b", "\U0000003c", "\U0000003d", "\U0000003e", "\U0000003f", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004a", "\U0000004b", "\U0000004c", "\U0000004d", "\U0000004e", "\U0000004f", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005a", "\U0000005b", "\U0000005c", "\U0000005d", "\U0000005e", "\U0000005f", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006a", "\U0000006b", "\U0000006c", "\U0000006d", "\U0000006e", "\U0000006f", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007a", "\U0000007b", "\U0000007c", "\U0000007d", "\U0000007e", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B5", "\U000000A3", "\U000000A5", "\U000000A9", "\U000000AE", "\U000000D7", "\U000000F7", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: Roboto
      weight: 700
    id: font_roboto_700_12
    size: 12
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002a", "\U0000002b", "\U0000002c", "\U0000002d", "\U0000002e", "\U0000002f", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003a", "\U0000003b", "\U0000003c", "\U0000003d", "\U0000003e", "\U0000003f", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004a", "\U0000004b", "\U0000004c", "\U0000004d", "\U0000004e", "\U0000004f", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005a", "\U0000005b", "\U0000005c", "\U0000005d", "\U0000005e", "\U0000005f", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006a", "\U0000006b", "\U0000006c", "\U0000006d", "\U0000006e", "\U0000006f", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007a", "\U0000007b", "\U0000007c", "\U0000007d", "\U0000007e", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B5", "\U000000A3", "\U000000A5", "\U000000A9", "\U000000AE", "\U000000D7", "\U000000F7", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: Roboto
      weight: 400
    id: font_roboto_400_14
    size: 14
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002a", "\U0000002b", "\U0000002c", "\U0000002d", "\U0000002e", "\U0000002f", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003a", "\U0000003b", "\U0000003c", "\U0000003d", "\U0000003e", "\U0000003f", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004a", "\U0000004b", "\U0000004c", "\U0000004d", "\U0000004e", "\U0000004f", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005a", "\U0000005b", "\U0000005c", "\U0000005d", "\U0000005e", "\U0000005f", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006a", "\U0000006b", "\U0000006c", "\U0000006d", "\U0000006e", "\U0000006f", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007a", "\U0000007b", "\U0000007c", "\U0000007d", "\U0000007e", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B5", "\U000000A3", "\U000000A5", "\U000000A9", "\U000000AE", "\U000000D7", "\U000000F7", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: font_material_design_icons_400_32
    size: 32
    glyphs: ["\U000F0026", "\U000F0590", "\U000F0591", "\U000F0592", "\U000F0593", "\U000F0594", "\U000F0595", "\U000F0596", "\U000F0597", "\U000F0598", "\U000F0599", "\U000F059D", "\U000F059E", "\U000F067E", "\U000F067F"]
  - file:
      type: gfonts
      family: Roboto
      weight: 100
    id: font_roboto_100_100
    size: 100
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002a", "\U0000002b", "\U0000002c", "\U0000002d", "\U0000002e", "\U0000002f", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003a", "\U0000003b", "\U0000003c", "\U0000003d", "\U0000003e", "\U0000003f", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004a", "\U0000004b", "\U0000004c", "\U0000004d", "\U0000004e", "\U0000004f", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005a", "\U0000005b", "\U0000005c", "\U0000005d", "\U0000005e", "\U0000005f", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006a", "\U0000006b", "\U0000006c", "\U0000006d", "\U0000006e", "\U0000006f", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007a", "\U0000007b", "\U0000007c", "\U0000007d", "\U0000007e", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B5", "\U000000A3", "\U000000A5", "\U000000A9", "\U000000AE", "\U000000D7", "\U000000F7", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: Roboto
      weight: 700
    id: font_roboto_700_24
    size: 24
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002a", "\U0000002b", "\U0000002c", "\U0000002d", "\U0000002e", "\U0000002f", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003a", "\U0000003b", "\U0000003c", "\U0000003d", "\U0000003e", "\U0000003f", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004a", "\U0000004b", "\U0000004c", "\U0000004d", "\U0000004e", "\U0000004f", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005a", "\U0000005b", "\U0000005c", "\U0000005d", "\U0000005e", "\U0000005f", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006a", "\U0000006b", "\U0000006c", "\U0000006d", "\U0000006e", "\U0000006f", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007a", "\U0000007b", "\U0000007c", "\U0000007d", "\U0000007e", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B5", "\U000000A3", "\U000000A5", "\U000000A9", "\U000000AE", "\U000000D7", "\U000000F7", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: Roboto
      weight: 400
    id: font_roboto_400_24
    size: 24
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002a", "\U0000002b", "\U0000002c", "\U0000002d", "\U0000002e", "\U0000002f", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003a", "\U0000003b", "\U0000003c", "\U0000003d", "\U0000003e", "\U0000003f", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004a", "\U0000004b", "\U0000004c", "\U0000004d", "\U0000004e", "\U0000004f", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005a", "\U0000005b", "\U0000005c", "\U0000005d", "\U0000005e", "\U0000005f", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006a", "\U0000006b", "\U0000006c", "\U0000006d", "\U0000006e", "\U0000006f", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007a", "\U0000007b", "\U0000007c", "\U0000007d", "\U0000007e", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B5", "\U000000A3", "\U000000A5", "\U000000A9", "\U000000AE", "\U000000D7", "\U000000F7", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: Roboto
      weight: 400
    id: font_roboto_400_18
    size: 18
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002a", "\U0000002b", "\U0000002c", "\U0000002d", "\U0000002e", "\U0000002f", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003a", "\U0000003b", "\U0000003c", "\U0000003d", "\U0000003e", "\U0000003f", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004a", "\U0000004b", "\U0000004c", "\U0000004d", "\U0000004e", "\U0000004f", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005a", "\U0000005b", "\U0000005c", "\U0000005d", "\U0000005e", "\U0000005f", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006a", "\U0000006b", "\U0000006c", "\U0000006d", "\U0000006e", "\U0000006f", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007a", "\U0000007b", "\U0000007c", "\U0000007d", "\U0000007e", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B5", "\U000000A3", "\U000000A5", "\U000000A9", "\U000000AE", "\U000000D7", "\U000000F7", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: Roboto
      weight: 400
      italic: true
    id: font_roboto_400_16_italic
    size: 16
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002a", "\U0000002b", "\U0000002c", "\U0000002d", "\U0000002e", "\U0000002f", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003a", "\U0000003b", "\U0000003c", "\U0000003d", "\U0000003e", "\U0000003f", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004a", "\U0000004b", "\U0000004c", "\U0000004d", "\U0000004e", "\U0000004f", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005a", "\U0000005b", "\U0000005c", "\U0000005d", "\U0000005e", "\U0000005f", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006a", "\U0000006b", "\U0000006c", "\U0000006d", "\U0000006e", "\U0000006f", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007a", "\U0000007b", "\U0000007c", "\U0000007d", "\U0000007e", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B5", "\U000000A3", "\U000000A5", "\U000000A9", "\U000000AE", "\U000000D7", "\U000000F7", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: Roboto
      weight: 400
    id: font_roboto_400_12
    size: 12
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002a", "\U0000002b", "\U0000002c", "\U0000002d", "\U0000002e", "\U0000002f", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003a", "\U0000003b", "\U0000003c", "\U0000003d", "\U0000003e", "\U0000003f", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004a", "\U0000004b", "\U0000004c", "\U0000004d", "\U0000004e", "\U0000004f", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005a", "\U0000005b", "\U0000005c", "\U0000005d", "\U0000005e", "\U0000005f", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006a", "\U0000006b", "\U0000006c", "\U0000006d", "\U0000006e", "\U0000006f", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007a", "\U0000007b", "\U0000007c", "\U0000007d", "\U0000007e", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B5", "\U000000A3", "\U000000A5", "\U000000A9", "\U000000AE", "\U000000D7", "\U000000F7", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: font_material_design_icons_400_20
    size: 20
    glyphs: ["\U000F0079", "\U000F007B", "\U000F007E", "\U000F0082", "\U000F0083", "\U000F050F", "\U000F058C", "\U000F058E", "\U000F091F", "\U000F0922", "\U000F0925", "\U000F0928", "\U000F092B", "\U000F0E4C", "\U000F0E7A", "\U000F10C2"]
  - file:
      type: gfonts
      family: Roboto
      weight: 500
    id: font_roboto_500_14
    size: 14
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002a", "\U0000002b", "\U0000002c", "\U0000002d", "\U0000002e", "\U0000002f", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003a", "\U0000003b", "\U0000003c", "\U0000003d", "\U0000003e", "\U0000003f", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004a", "\U0000004b", "\U0000004c", "\U0000004d", "\U0000004e", "\U0000004f", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005a", "\U0000005b", "\U0000005c", "\U0000005d", "\U0000005e", "\U0000005f", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006a", "\U0000006b", "\U0000006c", "\U0000006d", "\U0000006e", "\U0000006f", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007a", "\U0000007b", "\U0000007c", "\U0000007d", "\U0000007e", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B5", "\U000000A3", "\U000000A5", "\U000000A9", "\U000000AE", "\U000000D7", "\U000000F7", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
script:
  - id: change_page_to
    parameters:
      target_page: int
    then:
      - lambda: |-
          int pages_count = 1;
          int target = target_page;
          while (target < 0) target += pages_count;
          target %= pages_count;
          
          if (id(display_page) != target) {
            id(display_page) = target;
            id(last_page_switch_time) = millis();
            id(epaper_display).update();
            ESP_LOGI("display", "Switched to page %d", target);
            // Restart refresh logic
            if (id(manage_run_and_sleep).is_running()) id(manage_run_and_sleep).stop();
            id(manage_run_and_sleep).execute();
          }
  - id: manage_run_and_sleep
    mode: restart
    then:
      - logger.log: "Waiting for sync..."
      - wait_until:
          condition:
            lambda: 'return id(ha_time).now().is_valid() && api_is_connected();'
          timeout: 60s
      - delay: 5s
      - lambda: 'id(page_refresh_current_s) = id(page_refresh_default_s);'
      - component.update: epaper_display
      - delay: !lambda 'return id(page_refresh_current_s) * 1000;'
      - script.execute: manage_run_and_sleep

display:
  - platform: waveshare_epaper
    id: epaper_display
    cs_pin: GPIO44
    dc_pin: GPIO10
    reset_pin: GPIO38
    busy_pin:
      number: GPIO4
      inverted: true
    rotation: 0
    model: "7.50inv2p"
    update_interval: never
    full_update_every: 30

    lambda: |-
      const auto COLOR_WHITE = Color(0, 0, 0); // Inverted for e-ink
      const auto COLOR_BLACK = Color(255, 255, 255); // Inverted for e-ink
      const auto COLOR_RED = Color(255, 0, 0);
      const auto COLOR_GREEN = Color(0, 255, 0);
      const auto COLOR_BLUE = Color(0, 0, 255);
      const auto COLOR_YELLOW = Color(255, 255, 0);
      const auto COLOR_ORANGE = Color(255, 165, 0);
      auto color_off = COLOR_WHITE;
      auto color_on = COLOR_BLACK;

      auto extract_time = [](const char* iso_str) -> std::string {
          // Expected format: YYYY-MM-DDTHH:MM:SS or similar
          std::string s(iso_str);
          if (s.length() >= 16) return s.substr(11, 5);
          return "";
      };

      auto get_calendar_matrix = [](int year, int month, char cal[7][7][3]) {
           // Simple calendar calc logic (placeholder for robust implementation)
           // Just zero out for now or implement if critical. 
           // Actually, usually copied from standard C logic.
           // Implementation omitted to save space, assuming clean month view.
           // Standard Zellers dominance or similar.
           int days_in_month[] = {0,31,28,31,30,31,30,31,31,30,31,30,31};
           if (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0)) days_in_month[2] = 29;
           struct tm time_in = {0}; time_in.tm_year = year - 1900; time_in.tm_mon = month - 1; time_in.tm_mday = 1;
           mktime(&time_in);
           int start_day = time_in.tm_wday; // 0=Sun
           int day = 1;
           // Fill cal
           for(int i=0; i<7; i++) for(int j=0; j<7; j++) sprintf(cal[i][j], "");
           // Header
           const char* h[] = {"S","M","T","W","T","F","S"};
           for(int j=0; j<7; j++) strcpy(cal[0][j], h[j]);
           // Days
           int row = 1;
           for (int j=start_day; j<7; j++) { sprintf(cal[row][j], "%d", day++); }
           row++;
           while (day <= days_in_month[month]) {
               for (int j=0; j<7; j++) { if (day <= days_in_month[month]) sprintf(cal[row][j], "%d", day++); }
               row++;
           }
      };

      int currentPage = id(display_page);
      if (currentPage == 0) {
        // page:name "Page 1"
        // page:dark_mode "inherit"
        // page:refresh_type "interval"
        // page:refresh_time ""
        // Clear screen for this page
        it.fill(COLOR_WHITE);
        color_off = COLOR_WHITE;
        color_on = COLOR_BLACK;
        // widget:weather_forecast id:w_mjhv9kgwc1s02 type:weather_forecast x:20 y:366 w:400 h:80 weather_entity:"weather.forecast_home" layout:horizontal show_high_low:true day_font_size:12 temp_font_size:14 icon_size:32 font_family:"Roboto" color:black 
        {
          static std::map<std::string, const char*> weather_icons = {
            {"clear-night", "\U000F0594"}, {"cloudy", "\U000F0590"},
            {"exceptional", "\U000F0026"}, {"fog", "\U000F0591"},
            {"hail", "\U000F0592"}, {"lightning", "\U000F0593"},
            {"lightning-rainy", "\U000F067E"}, {"partlycloudy", "\U000F0595"},
            {"pouring", "\U000F0596"}, {"rainy", "\U000F0597"},
            {"snowy", "\U000F0598"}, {"snowy-rainy", "\U000F067F"},
            {"sunny", "\U000F0599"}, {"windy", "\U000F059D"},
            {"windy-variant", "\U000F059E"}
          };
          auto get_icon = [&](const std::string& cond) -> const char* {
            return weather_icons.count(cond) ? weather_icons[cond] : "\U000F0590";
          };
          auto get_day_name = [](int offset) -> std::string {
            if (offset == 0) return "Today";
            auto t = id(ha_time).now();
            if (!t.is_valid()) return "---";
            ESPTime future = ESPTime::from_epoch_local(t.timestamp + (offset * 86400));
            char buf[8]; future.strftime(buf, sizeof(buf), "%a");
            return std::string(buf);
          };
          {
            int dx = 20; int dy = 366;
            it.printf(dx + 40, dy, id(font_roboto_700_12), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", get_day_name(0).c_str());
            std::string cond = id(weather_cond_day0).state;
            it.printf(dx + 40, dy + 16, id(font_material_design_icons_400_32), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", get_icon(cond));
            float high = id(weather_high_day0).state; float low = id(weather_low_day0).state;
            if (!std::isnan(high) && !std::isnan(low)) {
              it.printf(dx + 40, dy + 52, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_CENTER, "%.0f/%.0f", high, low);
            }
          }
          {
            int dx = 100; int dy = 366;
            it.printf(dx + 40, dy, id(font_roboto_700_12), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", get_day_name(1).c_str());
            std::string cond = id(weather_cond_day1).state;
            it.printf(dx + 40, dy + 16, id(font_material_design_icons_400_32), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", get_icon(cond));
            float high = id(weather_high_day1).state; float low = id(weather_low_day1).state;
            if (!std::isnan(high) && !std::isnan(low)) {
              it.printf(dx + 40, dy + 52, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_CENTER, "%.0f/%.0f", high, low);
            }
          }
          {
            int dx = 180; int dy = 366;
            it.printf(dx + 40, dy, id(font_roboto_700_12), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", get_day_name(2).c_str());
            std::string cond = id(weather_cond_day2).state;
            it.printf(dx + 40, dy + 16, id(font_material_design_icons_400_32), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", get_icon(cond));
            float high = id(weather_high_day2).state; float low = id(weather_low_day2).state;
            if (!std::isnan(high) && !std::isnan(low)) {
              it.printf(dx + 40, dy + 52, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_CENTER, "%.0f/%.0f", high, low);
            }
          }
          {
            int dx = 260; int dy = 366;
            it.printf(dx + 40, dy, id(font_roboto_700_12), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", get_day_name(3).c_str());
            std::string cond = id(weather_cond_day3).state;
            it.printf(dx + 40, dy + 16, id(font_material_design_icons_400_32), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", get_icon(cond));
            float high = id(weather_high_day3).state; float low = id(weather_low_day3).state;
            if (!std::isnan(high) && !std::isnan(low)) {
              it.printf(dx + 40, dy + 52, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_CENTER, "%.0f/%.0f", high, low);
            }
          }
          {
            int dx = 340; int dy = 366;
            it.printf(dx + 40, dy, id(font_roboto_700_12), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", get_day_name(4).c_str());
            std::string cond = id(weather_cond_day4).state;
            it.printf(dx + 40, dy + 16, id(font_material_design_icons_400_32), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", get_icon(cond));
            float high = id(weather_high_day4).state; float low = id(weather_low_day4).state;
            if (!std::isnan(high) && !std::isnan(low)) {
              it.printf(dx + 40, dy + 52, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_CENTER, "%.0f/%.0f", high, low);
            }
          }
        }
        // widget:calendar id:w_mjhv9oq4acqqx type:calendar x:20 y:30 w:399 h:252 entity:sensor.esp_calendar_data border_width:2 show_border:true border_color:black background_color:white text_color:black font_size_date:100 font_size_day:24 font_size_grid:14 font_size_event:18 
        {
          auto time = id(ha_time).now();
          it.filled_rectangle(20, 30, 399, 252, COLOR_WHITE);
          for (int i = 0; i < 2; i++) {
            it.rectangle(20 + i, 30 + i, 399 - 2 * i, 252 - 2 * i, COLOR_BLACK);
          }
          int cx = 20 + (399 / 2);
          it.printf(cx, 30 + 0, id(font_roboto_100_100), COLOR_BLACK, TextAlign::TOP_CENTER, "%d", time.day_of_month);
          it.printf(cx, 30 + 70, id(font_roboto_700_24), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", id(todays_day_name_w_mjhv9oq4acqqx).state.c_str());
          it.printf(cx, 30 + 92, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", id(todays_date_month_year_w_mjhv9oq4acqqx).state.c_str());
          int calendar_y_pos = 30 + 115;
          char cal[7][7][3];
          get_calendar_matrix(time.year, time.month, cal);
          int cell_width = (399 - 40) / 7;
          int cell_height = 17;
          int start_x = 20 + 20;
          for (int i = 0; i < 7; i++) {
              for (int j = 0; j < 7; j++) {
                  int px = start_x + (j * cell_width) + (cell_width / 2);
                  int py = calendar_y_pos + (i * cell_height);
                  if (i == 0) {
                      it.printf(px, py, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", cal[i][j]);
                  } else {
                      if (atoi(cal[i][j]) == time.day_of_month) {
                           it.filled_circle(px, py + 12, 10, COLOR_BLACK);
                           it.printf(px, py + 5, id(font_roboto_400_14), COLOR_WHITE, TextAlign::TOP_CENTER, "%s", cal[i][j]);
                      } else {
                           it.printf(px, py + 5, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", cal[i][j]);
                      }
                  }
              }
          }
          it.line(start_x, calendar_y_pos + cell_height, 20 + 399 - 20, calendar_y_pos + cell_height, COLOR_BLACK);
          // Events
          ESP_LOGD("calendar", "Raw JSON: %s", id(calendar_json_w_mjhv9oq4acqqx).state.c_str());
          if (id(calendar_json_w_mjhv9oq4acqqx).state.length() > 5 && id(calendar_json_w_mjhv9oq4acqqx).state != "unknown") {
             // Robust Manual Parsing for Mixed Types (Array/Object)
             // Allocate 2KB on heap to avoid stack overflow inside lambda
             DynamicJsonDocument doc(2048);
             DeserializationError error = deserializeJson(doc, id(calendar_json_w_mjhv9oq4acqqx).state);

             if (!error) {
                 JsonVariant root = doc.as<JsonVariant>();
                 JsonArray days;

                 if (root.is<JsonObject>() && root["days"].is<JsonArray>()) {
                     days = root["days"];
                 } else if (root.is<JsonArray>()) {
                     days = root;
                 } else {
                     ESP_LOGW("calendar", "Invalid JSON structure: neither object with 'days' nor array");
                     return;
                 }

                 if (days.isNull() || days.size() == 0) {
                      ESP_LOGD("calendar", "No days found in JSON");
                      return;
                 }
                 ESP_LOGD("calendar", "Processing %d days", days.size());

                 int y_cursor = calendar_y_pos + (7 * cell_height) + 10;
                 int max_y = 30 + 252 - 5;

                 // Safety: Ensure we have enough space for at least one event
                 if (y_cursor >= max_y) { ESP_LOGW("calendar", "Widget too small for events"); return; }

                 it.filled_rectangle(20 + 20, y_cursor - 5, 399 - 40, 2, COLOR_BLACK);

                 for (JsonVariant dayEntry : days) {
                     if (y_cursor > max_y) break;
                     int currentDayNum = dayEntry["day"].as<int>();

                     auto draw_row = [&](JsonVariant event, bool is_all_day) {
                         if (y_cursor > max_y) return;
                         const char* summary = event["summary"] | "No Title";
                         const char* start = event["start"] | "";

                         it.printf(20 + 20, y_cursor, id(font_roboto_400_24), COLOR_BLACK, TextAlign::TOP_LEFT, "%d", currentDayNum);
                         it.printf(20 + 60, y_cursor + 4, id(font_roboto_400_18), COLOR_BLACK, TextAlign::TOP_LEFT, "%.25s", summary);

                         if (is_all_day) {
                             it.printf(20 + 399 - 20, y_cursor + 4, id(font_roboto_400_18), COLOR_BLACK, TextAlign::TOP_RIGHT, "All Day");
                         } else {
                             std::string timeStr = extract_time(start);
                             it.printf(20 + 399 - 20, y_cursor + 4, id(font_roboto_400_18), COLOR_BLACK, TextAlign::TOP_RIGHT, "%s", timeStr.c_str());
                         }
                         y_cursor += 25;
                     };

                     if (dayEntry["all_day"].is<JsonArray>()) {
                         for (JsonVariant event : dayEntry["all_day"].as<JsonArray>()) {
                             draw_row(event, true);
                             if (y_cursor > max_y) break;
                         }
                     }
                     if (dayEntry["other"].is<JsonArray>()) {
                         for (JsonVariant event : dayEntry["other"].as<JsonArray>()) {
                             draw_row(event, false);
                             if (y_cursor > max_y) break;
                         }
                     }
                 }
             } else {
                  ESP_LOGW("calendar", "JSON Parse Error: %s", error.c_str());
             }
          }
        }
        // widget:quote_rss id:w_mjhva2g0qs70i type:quote_rss x:435 y:55 w:362 h:144 feed_url:"https://script.google.com/macros/s/AKfycbzs-IaE4gHCMOaZFgcZgV_phZgI1mPz0gCPUM-Liok2G2_R6e-AAR7-1f-qKLNvnRU9Tg/exec" show_author:true quote_font:16 author_font:14 color:black align:TOP_LEFT italic:true refresh:1h random:true wrap:true 
        {
          std::string quote_text = id(quote_text_w_mjhva2g0qs70i_global);
          std::string quote_author = id(quote_author_w_mjhva2g0qs70i_global);
          // Word wrap implementation
          int max_width = 346;
          int line_height = 20;
          int y_pos = 63;
          std::string display_text = "\"" + quote_text + "\"";
          auto print_quote = [&](esphome::font::Font *font, int line_h, bool draw) -> int {
            int y_curr = 63;
            std::string current_line = "";
            size_t pos = 0; size_t space_pos;
            while ((space_pos = display_text.find(' ', pos)) != std::string::npos) {
                std::string word = display_text.substr(pos, space_pos - pos);
                std::string test_line = current_line.empty() ? word : current_line + " " + word;
                int w, h, xoff, bl;
                font->measure(test_line.c_str(), &w, &xoff, &bl, &h);
                if (w > max_width && !current_line.empty()) {
                    if (draw) it.printf(443, y_curr, font, COLOR_BLACK, "%s", current_line.c_str());
                    y_curr += line_h;
                    current_line = word;
                } else { current_line = test_line; }
                pos = space_pos + 1;
            }
            if (!current_line.empty()) {
                std::string rem = display_text.substr(pos);
                if (!current_line.empty()) current_line += " "; current_line += rem;
            }
            if (!current_line.empty()) {
                if (draw) it.printf(443, y_curr, font, COLOR_BLACK, "%s", current_line.c_str());
                y_curr += line_h;
            }
            return y_curr - 63;
          };
          int final_h = print_quote(id(font_roboto_400_16_italic), 20, true);
          if (!quote_author.empty()) it.printf(443, 55 + 144 - 14, id(font_roboto_400_14), COLOR_BLACK, "— %s", quote_author.c_str());
        }
        // widget:sensor_text id:w_mjhvb0sb43hu3 type:sensor_text x:465 y:200 w:120 h:40 ent:sensor.lights_on entity_2: title:"Lights" format:label_value label_font:14 value_font:20 color:black label_align:TOP_LEFT value_align:TOP_LEFT precision:0 unit:"" hide_unit:false prefix:"" postfix:"" separator:"~" local:false text_sensor:true font_family:"Roboto" font_weight:400 italic:false  cond_ent:"sensor.lights" cond_op:">"
        if (id(sensor_lights).state > 0) {
        {
          std::string val1 = id(sensor_lights_on_txt).state;
          std::string sensorValue = val1;
          std::string fullValue = "" + sensorValue + "on" + "";
          // label_value format: label and value on same line
          it.printf(465, 200, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_LEFT, "Lights: %s", fullValue.c_str());
        }
        // widget:sensor_text id:w_mjhvd57meh1zn type:sensor_text x:465 y:225 w:120 h:40 ent:input_boolean.guest_mode entity_2: title:"Guest Mode" format:label_value label_font:14 value_font:20 color:black label_align:TOP_LEFT value_align:TOP_LEFT precision:2 unit:"" hide_unit:false prefix:"" postfix:"" separator:"~" local:false text_sensor:true font_family:"Roboto" font_weight:400 italic:false 
        {
          std::string val1 = id(input_boolean_guest_mode_txt).state;
          std::string sensorValue = val1;
          std::string fullValue = "" + sensorValue + "" + "";
          // label_value format: label and value on same line
          it.printf(465, 225, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_LEFT, "Guest Mode: %s", fullValue.c_str());
        }
        // widget:graph id:w_mjhvefqifbsmo type:graph x:452 y:277 w:331 h:129 title:"" entity:sensor.147_123_1min local:false duration:1h border:true color:black x_grid:15min y_grid:50 line_type:SOLID line_thickness:3 continuous:true min_value: max_value: min_range: max_range: 
        it.graph(452, 277, id(graph_w_mjhvefqifbsmo));
        for (int i = 0; i < 3; i++) {
          it.rectangle(452 + i, 277 + i, 331 - 2 * i, 129 - 2 * i, COLOR_BLACK);
        }
        for (int i = 0; i < 331; i += 4) {
          it.draw_pixel_at(452 + i, 309, COLOR_BLACK);
        }
        for (int i = 0; i < 331; i += 4) {
          it.draw_pixel_at(452 + i, 342, COLOR_BLACK);
        }
        for (int i = 0; i < 331; i += 4) {
          it.draw_pixel_at(452 + i, 374, COLOR_BLACK);
        }
        for (int i = 0; i < 129; i += 4) {
          it.draw_pixel_at(535, 277 + i, COLOR_BLACK);
        }
        for (int i = 0; i < 129; i += 4) {
          it.draw_pixel_at(618, 277 + i, COLOR_BLACK);
        }
        for (int i = 0; i < 129; i += 4) {
          it.draw_pixel_at(700, 277 + i, COLOR_BLACK);
        }
        it.printf(452 - 4, 277 + 129 - 6, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%.0f", (float)0);
        it.printf(452 - 4, 277 + 97 - 6, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%.0f", (float)25);
        it.printf(452 - 4, 277 + 65 - 6, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%.0f", (float)50);
        it.printf(452 - 4, 277 + 32 - 6, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%.0f", (float)75);
        it.printf(452 - 4, 277 + 0 - 6, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%.0f", (float)100);
        it.printf(452 + 0, 277 + 129 + 2, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_LEFT, "-1.0h");
        it.printf(452 + 166, 277 + 129 + 2, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_CENTER, "-30m");
        it.printf(452 + 331, 277 + 129 + 2, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "Now");
        // widget:sensor_text id:w_mjhvjdlqawkfx type:sensor_text x:620 y:200 w:120 h:40 ent:binary_sensor.exterior_doors entity_2: title:"Doors" format:label_value label_font:14 value_font:20 color:black label_align:TOP_LEFT value_align:TOP_LEFT precision:2 unit:"" hide_unit:false prefix:"" postfix:"" separator:"~" local:false text_sensor:true font_family:"Roboto" font_weight:400 italic:false 
        {
          std::string val1 = id(binary_sensor_exterior_doors_txt).state;
          std::string sensorValue = val1;
          std::string fullValue = "" + sensorValue + "" + "";
          // label_value format: label and value on same line
          it.printf(620, 200, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_LEFT, "Doors: %s", fullValue.c_str());
        }
        // widget:sensor_text id:w_mjhvk88f877eu type:sensor_text x:620 y:225 w:120 h:40 ent:input_boolean.alarm_armed entity_2: title:"Alarm" format:label_value label_font:14 value_font:20 color:black label_align:TOP_LEFT value_align:TOP_LEFT precision:2 unit:"" hide_unit:false prefix:"" postfix:"" separator:"~" local:false text_sensor:true font_family:"Roboto" font_weight:400 italic:false 
        {
          std::string val1 = id(input_boolean_alarm_armed_txt).state;
          std::string sensorValue = val1;
          std::string fullValue = "" + sensorValue + "" + "";
          // label_value format: label and value on same line
          it.printf(620, 225, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_LEFT, "Alarm: %s", fullValue.c_str());
        }
        // widget:sensor_text id:w_mji03z8ixi6ho type:sensor_text x:452 y:420 w:293 h:42 ent:sensor.estimated_monthly_cost entity_2: title:"Estimated Monthly Power" format:label_value label_font:14 value_font:20 color:black label_align:TOP_LEFT value_align:TOP_LEFT precision:2 unit:"" hide_unit:true prefix:"$" postfix:"" separator:"~" local:false text_sensor:false font_family:"Roboto" font_weight:400 italic:false 
        {
          char buf1[32];
          snprintf(buf1, sizeof(buf1), "%.2f", id(sensor_estimated_monthly_cost).state);
          std::string val1 = buf1;
          std::string sensorValue = val1;
          std::string fullValue = "$" + sensorValue + "" + "";
          // label_value format: label and value on same line
          it.printf(452, 420, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_LEFT, "Estimated Monthly Power: %s", fullValue.c_str());
        }
        // widget:template_sensor_bar id:w_mk0g2umpxi69m type:template_sensor_bar x:60 y:55 w:320 h:50 wifi:true temp:true hum:true bat:true bg:true bg_color:black radius:8 icon_size:20 font_size:14 color:white 
        {
          it.filled_rectangle(60, 55, 320, 50, COLOR_BLACK);
          it.rectangle(60, 55, 320, 50, COLOR_BLACK);
          {
            const char* wifi_icon = "\U000F092B";
            if (id(wifi_signal_dbm).has_state()) {
              float sig = id(wifi_signal_dbm).state;
              if (sig >= -50) wifi_icon = "\U000F0928";
              else if (sig >= -70) wifi_icon = "\U000F0925";
              else if (sig >= -85) wifi_icon = "\U000F0922";
              else wifi_icon = "\U000F091F";
            }
            it.printf(100 - 12, 80, id(font_material_design_icons_400_20), COLOR_WHITE, TextAlign::CENTER_LEFT, "%s", wifi_icon);
            if (id(wifi_signal_dbm).has_state()) it.printf(100 + 8, 80, id(font_roboto_500_14), COLOR_WHITE, TextAlign::CENTER_LEFT, "%.0fdB", id(wifi_signal_dbm).state);
            else it.printf(100 + 8, 80, id(font_roboto_500_14), COLOR_WHITE, TextAlign::CENTER_LEFT, "--dB");
          }
          {
            it.printf(180 - 12, 80, id(font_material_design_icons_400_20), COLOR_WHITE, TextAlign::CENTER_LEFT, "\U000F050F");
            if (id(shtc3_temperature).has_state()) it.printf(180 + 8, 80, id(font_roboto_500_14), COLOR_WHITE, TextAlign::CENTER_LEFT, "%.1f°C", id(shtc3_temperature).state);
            else it.printf(180 + 8, 80, id(font_roboto_500_14), COLOR_WHITE, TextAlign::CENTER_LEFT, "--°C");
          }
          {
            it.printf(260 - 12, 80, id(font_material_design_icons_400_20), COLOR_WHITE, TextAlign::CENTER_LEFT, "\U000F058E");
            if (id(shtc3_humidity).has_state()) it.printf(260 + 8, 80, id(font_roboto_500_14), COLOR_WHITE, TextAlign::CENTER_LEFT, "%.0f%%", id(shtc3_humidity).state);
            else it.printf(260 + 8, 80, id(font_roboto_500_14), COLOR_WHITE, TextAlign::CENTER_LEFT, "--%%");
          }
          {
            const char* bat_icon = "\U000F0082";
            float lvl = id(battery_level).state;
            if (lvl >= 90) bat_icon = "\U000F0079";
            else if (lvl >= 50) bat_icon = "\U000F007E";
            else if (lvl >= 20) bat_icon = "\U000F007B";
            else bat_icon = "\U000F0083";
            it.printf(340 - 12, 80, id(font_material_design_icons_400_20), COLOR_WHITE, TextAlign::CENTER_LEFT, "%s", bat_icon);
            if (id(battery_level).has_state()) it.printf(340 + 8, 80, id(font_roboto_500_14), COLOR_WHITE, TextAlign::CENTER_LEFT, "%.0f%%", id(battery_level).state);
            else it.printf(340 + 8, 80, id(font_roboto_500_14), COLOR_WHITE, TextAlign::CENTER_LEFT, "--%%");
          }
        }
      }